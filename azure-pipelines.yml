trigger:
- master

jobs:
- job: 'osx'
  pool:
    vmImage: macOS-10.13
  name: $(date:yyyy.MM.dd)$(rev:.rr)
  steps:
  - task: DotNetCoreInstaller@0
    displayName: 'Use .NET Core sdk 2.2.104'
    inputs:
      version: 2.2.104
  - task: DotNetCoreCLI@2
    displayName: 'dotnet restore'
    inputs:
      command: custom
      projects: src/Sannel.House.Users/Sannel.House.Users.csproj
      custom: restore
      arguments: '-r osx-x64 --configfile .nuget/nuget.config'
      feedsToUse: config
      nugetConfigPath: .nuget/nuget.config
      externalFeedCredentials: 'Sannel House MyGet'
  - task: DotNetCoreCLI@2
    displayName: 'dotnet build Release'
    inputs:
      projects: src/Sannel.House.Users/Sannel.House.Users.csproj
      arguments: '-r osx-x64 -c Release'
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
  - task: DotNetCoreCLI@2
    displayName: 'dotnet build Debug'
    inputs:
      projects: src/Sannel.House.Users/Sannel.House.Users.csproj
      arguments: '-r osx-x64 -c Debug'
    condition: and(succeeded(), ne(variables['Build.SourceBranch'], 'refs/heads/master'))
  - task: DotNetCoreCLI@2
    displayName: 'dotnet publish'
    inputs:
      command: publish
      publishWebProjects: false
      projects: src/Sannel.House.Users/Sannel.House.Users.csproj
      arguments: '-r osx-x64 -o $(Build.StagingDirectory)'
      zipAfterPublish: false
  - task: CopyFiles@2
    displayName: 'Copy Files to: $(Build.StagingDirectory)/Sannel.House.Users/app_config/'
    inputs:
      SourceFolder: 'src/Sannel.House.Users/app_config'
      Contents: |
        **/*.json
        **/*.yml
        **/*.pfx
        **/*.crt
      TargetFolder: '$(Build.StagingDirectory)/Sannel.House.Users/app_config/'
  - powershell: |
      New-Item -Type Directory -Force $(Build.StagingDirectory)/Sannel.House.Users/app_data/
      New-Item -Type File -Force $(Build.StagingDirectory)/Sannel.House.Users/app_data/.hold
    displayName: 'Prepare Items'
  - task: PublishPipelineArtifact@0
    displayName: 'Publish Pipeline Artifact'
    inputs:
      artifactName: 'osx-x64'
      targetPath: '$(Build.StagingDirectory)'

